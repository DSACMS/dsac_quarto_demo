---
title: "Quarto Demo for DSAC/Eng CoP"
subtitle: "Medicare Growth in Pennsylvania"
date: "2026-01-23"
format: html
theme: default
---


```{r}
#| label: dependencies
#| output: false
#| warnings: false
#| echo: false
library(tidyverse)
library(httr)
library(sf)
library(tigris)
library(scales)
library(gt)

options(tigris_use_cache = TRUE)

```

::: {.callout-tip}
## Base version

Let's start at square 1. Nothing fancy here. Basic yaml, use of markdown, code chunks, and inline code.

:::

::: {.callout-warning}

This demo report relies on R, but you can use R, Python, Julia, and Observable.

This demo report renders a document, but Quarto has a number of output options including documents, presentations, dahboards, websites, books.

:::

# BACKGROUND
This is an **important** annual report where we compare growth in beneficiaries at the county level in Pennsylvania. Public data on [monthly Medicare enrollments](https://data.cms.gov/summary-statistics-on-beneficiary-enrollment/medicare-and-medicaid-reports/medicare-monthly-enrollment) were pulled from Data.CMS.gov using the [API](https://data.cms.gov/summary-statistics-on-beneficiary-enrollment/medicare-and-medicaid-reports/medicare-monthly-enrollment/api-docs). 

```{r}
#| label: fetch_api

# function to fetch data from data.cms.gov
fetch_data <- function(state, year, dataset_uuid, baseurl = "https://data.cms.gov/data-api/v1") {
  
  endpoint <- str_glue("{baseurl}/dataset/{dataset_uuid}/data")
  
  request(endpoint) |>
    req_url_query(
      `filter[BENE_STATE_ABRVTN]` = state,
      `filter[YEAR]` = year,
      `filter[BENE_GEO_LVL]` = "County",
      `filter[MONTH]` = "Year",
      column = "BENE_STATE_DESC,BENE_STATE_ABRVTN,BENE_COUNTY_DESC,BENE_FIPS_CD,BENE_GEO_LVL,YEAR,MONTH,TOT_BENES"
    ) |>
    req_throttle(rate = 2) |>  #max requests/sec
    req_retry(max_tries = 3) |> 
    req_perform() |>
    resp_body_json()

}

```

```{r}
#| label: api_params

#parameters & global variables

#dataset type indentifier
dataset_uuid <- "d7fabe1e-d19b-4333-9eff-e80e0643f2fd"

#states of interest
states <- c("PA", "NY", "CA", "TX", "FL")

#years of interest
years <- c("2020", "2024")

#form expanded tibble for params to pull
params <- expand_grid(state = states, year = years, dataset_uuid = dataset_uuid)

#local dataset path
path_data <- "Data/medicare-monthly-enrollment_2025Oct_subset.csv"
```

```{r}
#| label: data_access

#run API if file doesn't already exist

if (!file.exists(path_data)){

    #API pull
    df_pull <- params |> 
        pmap(
            possibly(fetch_data, otherwise = NULL),
            .progress = TRUE
            ) |> 
    bind_rows()

    #create data folder if it doesn't exist
    dir.create(dirname(path_data), showWarnings = FALSE)

    #store data locally
    write_csv(df_pull, path_data, na = '')
}


```
```{r}
#| label: read_data 

#read in data
df <- read_csv(
    path_data, 
    col_types = c(year = "i", tot_benes = "i", .default = "c"),
    na = c("", "NA", "*"),
    name_repair = tolower
    )

```

```{r}
#| label: focus_state

#which state are we analyzing
focus_state <- "Pennsylvania"

```

Let's take a look at what data exists in this dataset. We can get more information at [Data.CMS.gov](https://data.cms.gov/summary-statistics-on-beneficiary-enrollment/medicare-and-medicaid-reports/medicare-monthly-enrollment). The dataset contains `r scales::label_comma()(nrow(df))` rows and `r ncol(df)` columns. The dataset covers the years from 2013 to `r max(df$year)`. For this analysis, we will only be looking at the total beneficiary counts (`tot_benes`) in `r focus_state` counties in 2020 and 2024.

## Initial Munge

Once the data were loaded, we clean them for ease of use and to calculate the growth rate over this period in time. We renamed columns to make them easier to work with and subset the data to the state and years of interest.

```{r}
#| label: initial_munge

#subset dataset
df_lim <- df |> 
    rename(
        state = bene_state_desc,
        state_abbr = bene_state_abrvtn,
        county = bene_county_desc,
        county_fips = bene_fips_cd
        ) |> 
    filter(
        state == {focus_state},
        month == "Year",
        bene_geo_lvl == "County",
        year %in% c(2020, 2024)
        )
    
#limit to cols of interest
df_lim <- df_lim |> 
    select(year, state, state_abbr, county, county_fips, tot_benes)

```

## Access Spatial Data

We also brought in spatial data to map the growth rates across the state, leveraging the [`tigris` package](https://github.com/walkerke/tigris). 

```{r}
#| label: spatial

# Download county boundaries for your state
state_counties <- counties(state = unique(df_lim$state_abbr), cb = TRUE, year = max(df_lim$year))

# Convert to sf object if needed
state_counties_sf <- st_as_sf(state_counties)

# Ensure FIPS codes match data format
state_counties_sf <- state_counties_sf %>%
  mutate(county_fips = GEOID)

```

# IMPORTANT ANALYSIS SECTION

Time to do some calculations!

## Calculate Growth Rate

We calcualted growth rates to identify the counties with the largest growth during this period.

```{r}
#reshape
df_gr <- df_lim |> 
    mutate(pd = ifelse(year == max(year), "end", "start")) |> 
    select(-year) |> 
    pivot_wider(
        names_from = pd,
        values_from = tot_benes)

df_gr <- df_gr |> 
    mutate(
        gr_pct = (end - start) / start,
        gr_abs = end - start)
```

## Join Data

Before we were able to visualize it, we needed to join the spatial data with the enrollment data by FIPS codes.

```{r}
#| label: merge

df_viz <- state_counties_sf %>%
  left_join(df_gr, by = "county_fips")

```

# VIZ

Okay, time for the fun stuff - data viz!

## Top Counties

Here are `r {focus_state}`'s 5 largest counties in terms of growth rate over this period.

```{r}
#| label: county growth rate tbl
#| output: true

df_gr |> 
    slice_max(order_by = gr_pct, n = 5) |> 
    select(county, start, end, gr_pct) |> 
    gt() |>  
    fmt_number(
        columns = c(start, end),
        decimals = 0
    ) |> 
    fmt_percent(
        columns = gr_pct,
        decimals = 1 
            ) |> 
    cols_label(
        county = "County",
        start = 2020,
        end = 2024,
        gr_pct = "Growth Rate"
    ) 

```

## State Map

We can `r {focus_state}`'s visualize all county growth rate data for comparison in a map.

```{r}
#| label: county growth rate
#| output: true

df_viz |> 
    ggplot() +
    geom_sf(aes(fill = gr_pct), color = "white", size = 0.2) +
    geom_sf_text(
        data = df_viz |> slice_max(order_by = gr_pct, n = 5),
        aes(label = county), na.rm = TRUE,
        ) +
    scale_fill_gradient2(
        low = "#af8dc3",
        mid = "#f7f7f7",
        high = "#7fbf7b",
        midpoint = 0,
        name = "Growth (%)",
        labels = percent_format(scale = 1)
    ) +
    labs(
        x = NULL, y = NULL,
        title = "Medicare Beneficiary Growth by County",
        subtitle = str_glue("{focus_state} | Percent change in total enrollment (2020-2024)"),
        caption = "Source: Medicare Monthly Enrollment Data, Data.CMS.gov"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(face = "bold", size = 16),
        legend.position = "top",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()
    )
```

---

*All data are public and sourced from [Data.CMS.gov](https://data.cms.gov)*

*Disclaimer: The findings, interpretation, and conclusions expressed herein are those of the authors and do not necessarily reflect the views of Centers for Medicare and Medicaid Services. All errors remain our own.*